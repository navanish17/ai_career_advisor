name: Sync to Hugging Face Spaces

on:
  push:
    branches: [main]

jobs:
  sync-to-hub:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: false
      
      # Step 1: Run Tests (Quality Gate)
      - name: Set up Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          
      - name: Run Tests
        run: |
          if [ -d "backend/test" ] || [ -d "backend/tests" ]; then
            cd backend
            pytest
          else
            echo "No tests found, skipping..."
          fi
        env:
          SMTP_HOST: "smtp.example.com"
          SMTP_PORT: "587"
          SMTP_USERNAME: "test_user"
          SMTP_PASSWORD: "test_password"
          SMTP_FROM_EMAIL: "test@example.com"
          SMTP_FROM_NAME: "Test User"

      # Step 2: Push to Hugging Face (Only if verification passes)
      - name: Push to Hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
        run: |
          git remote add space https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/ai-career-backend
          git push --force space main
